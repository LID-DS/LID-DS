import re
import sys

import requests
from bs4 import BeautifulSoup

# Variables
sec_level = 'low'
dvwa_user = 'admin'
dvwa_pass = 'password'
user_list = '/home/top_usernames_shortlist.txt'
pass_list = '/home/500_worst_passwords.txt'

# Value to look for in response header (Whitelisting)
success = 'Welcome to the password protected area'

# Get the anti-CSRF token

def csrf_token(target):
    try:
        # Make the request to the URL
        print(f"\n[i] URL: {target}/login.php")
        r = requests.get("{0}/login.php".format(target), allow_redirects=False)

    except Exception as e:
        print(e)
        # Feedback for the user (there was an error) & Stop execution of our request
        print(f"\n[!] csrf_token: Failed to connect (URL: {target}/login.php).\n[i] Quitting.")
        sys.exit(-1)

    # Extract anti-CSRF token
    soup = BeautifulSoup(r.text)
    user_token = soup("input", {"name": "user_token"})[0]["value"]
    print(f"[i] user_token: {user_token}")

    # Extract session information
    session_id = re.search("PHPSESSID=(.*?);", r.headers["set-cookie"])
    session_id = session_id.group(1)
    print(f"[i] session_id: {session_id}")

    return session_id, user_token


# Login to DVWA core
def dvwa_login(session_id, user_token, target):
    # POST data
    data = {
        "username": dvwa_user,
        "password": dvwa_pass,
        "user_token": user_token,
        "Login": "Login"
    }

    # Cookie data
    cookie = {
        "PHPSESSID": session_id,
        "security": sec_level
    }

    try:
        # Make the request to the URL
        print(f"\n[i] URL: {target}/login.php")
        print(f"[i] Data: {data}")
        print(f"[i] Cookie: {cookie}")
        r = requests.post(f"{target}/login.php", data=data, cookies=cookie, allow_redirects=False)

    except Exception as e:
        # Feedback for the user (there was an error) & Stop execution of our request
        print(f"\n\n[!] dvwa_login: Failed to connect (URL: {target}/login.php).\n[i] Quitting. {e}")
        sys.exit(-1)

    # Wasn't it a redirect?
    if r.status_code != 301 and r.status_code != 302:
        # Feedback for the user (there was an error again) & Stop execution of our request
        print(f"\n\n[!] dvwa_login: Page didn't response correctly (Response: {r.status_code}).\n[i] Quitting.")
        sys.exit(-1)

    # Did we log in successfully?
    if r.headers["Location"] != 'index.php':
        # Feedback for the user (there was an error) & Stop execution of our request
        print(
            f"\n\n[!] dvwa_login: Didn't login (Header: {r.headers['Location']}  user: {dvwa_user}  password: {dvwa_pass}  user_token: {user_token}  session_id: {session_id}).\n[i] Quitting.")
        sys.exit(-1)

    # If we got to here, everything should be okay!
    print(f"\n[i] Logged in! ({dvwa_user}/{dvwa_pass})\n")
    return True
