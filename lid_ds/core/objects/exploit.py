import secrets
import time

from lid_ds.core.collector.collector import Collector
from lid_ds.core.image import Image, ChainImage
from lid_ds.utils.docker_utils import format_command
from lid_ds.core.objects.base import ScenarioContainerBase
from lid_ds.sim.dockerize import run_image
from lid_ds.utils import log


class ScenarioExploit(ScenarioContainerBase):
    def __init__(self, image: ChainImage):
        super().__init__(image)
        self.container = None
        self.container_name = "attacker_%s" % secrets.token_hex(8)
        self.logger = log.get_logger(self.container_name, self.queue)

    def start_container(self):
        self.container = run_image(self.image.name, self.network, self.container_name)

    def execute_exploit_at_time(self, execution_time):
        while time.time() < execution_time:
            time.sleep(0.5)

        for command in self.image.commands:
            self.logger.info('Executing the exploit step %s now at %s' % (command.name, time.time()))
            cmd = format_command(command.command)
            if self.to_stdin:
                socket = self.container.attach_socket(params={'stdin': 1, 'stream': 1})
                socket._writing = True
                socket.write(cmd.encode() + b"\n")
            else:
                _, out = self.container.exec_run(cmd)
                for line in out.decode("utf-8").split("\n")[:-1]:
                    self.logger.info(line)
            Collector().set_exploit_step(command.name)

    def teardown(self):
        self.container.stop()
